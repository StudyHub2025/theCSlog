# 무중단 배포에 가까운 파이프라인 구축하기 
#### 블루그린 배포와 롤링배포 그 사이...
## 📌 개요

도커, Nginx, 심볼릭 링크 전환, 롤링 방식의 포트 교체를 통해 **무중단 배포에 가까운 환경**을 구축. 완전한 블루그린 배포는 아니지만, 그 흐름을 따라가며 실제 운영 중 서비스의 가용성을 유지할 수 있도록 설계.

## 🧩 핵심 구성 요소

* **Docker**: 서비스 이미지 실행
* **Nginx**: 리버스 프록시로 요청을 구동 중인 포트로 전달
* **심볼릭 링크 전환**: nginx 설정 파일 내 포트를 전환하는 방식
* **내부 네트워크**: Redis 등 부속 시스템과 통신을 위한 Docker Network 구성

## 🖼️ 전체 구조

```
사용자 요청
   │
로드밸런서
   │
프라이빗 서브넷 (서버)
   └── nginx (리버스 프록시)
         └── /etc/nginx/conf.d/app.conf → app_8080.conf 또는 app_8081.conf (심볼릭 링크)
                └── 현재 구동 중인 API 앱 컨테이너
                     └── 같은 Docker Network 내 Redis 컨테이너와 통신
```

## ⚙️ 배포 과정 요약

1. 새로운 Docker 이미지 빌드
2. 운영 중인 포트 확인 (예: 8080)
3. 다른 포트(8081)에 새로운 컨테이너 실행
4. Nginx 심볼릭 링크를 app_8081.conf로 교체
5. `nginx -s reload`로 설정 반영
6. 기존 컨테이너 종료 및 정리

## 🛠 Nginx 리버스 프록시 설정
```bash
# /etc/nginx/conf.d/app_8080.conf
server {
    listen 80;
    server_name _

    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```
심볼릭 링크 설정
```bash
# 이전 포트 설정 링크 제거
rm -f /etc/nginx/sites-enabled/app_8080.conf

# 새로운 포트를 가리키는 심볼릭 링크 생성
ln -s /etc/nginx/sites-available/app_8081.conf /etc/nginx/sites-enabled/app_8081.conf

# nginx 설정 리로드
nginx -s reload
```
---

### 🚀 배포 방식 비교 표

| 항목                    | 롤링 배포                              | 블루그린 배포                           | 현재 방식 (단일 서버 내 블루그린 구조)              |
|-----------------------|--------------------------------------|---------------------------------------|------------------------------------------------|
| 💡 배포 원리             | 인스턴스를 하나씩 새 버전으로 교체           | Blue와 Green 두 환경을 번갈아 사용        | 8080/8081 포트를 번갈아 사용하여 교체              |
| 🖥️ 서버 수              | 2대 이상 권장 (교체 중에도 서비스 가능)     | 2대 이상 필요 (Blue, Green 환경 분리)     | 1대 (포트로 Blue/Green 역할 분리)                |
| 🧱 인프라 구조 복잡도      | 중간                                  | 높음                                   | 낮음 (Nginx proxy_pass와 심볼릭 링크로 대체)     |
| 🔁 트래픽 전환 방식       | 로드밸런서가 점진적으로 새 인스턴스로 전환    | 트래픽을 Green으로 한 번에 전환          | 심볼릭 링크로 Nginx 설정을 새로운 포트로 전환       |
| ⏱️ 무중단 가능 여부       | 가능 (적절한 설정 시)                   | 가능 (완벽한 형태)                       | 거의 가능 (1초 내외 순간적 딜레이 있음)           |
| 🔁 롤백 용이성          | 낮음 (기존 인스턴스 상태 유지 어려움)       | 높음 (Blue 환경으로 즉시 롤백 가능)       | 중간 (이전 포트로 심볼릭 링크만 되돌리면 가능)     |
| 📦 배포 속도             | 느림 (순차 배포)                       | 빠름 (한 쪽 환경만 배포)                  | 빠름 (이미지 실행 후 포트 연결만 바꾸면 됨)         |
| 💰 비용               | 중간~높음 (다중 서버 필요)               | 높음 (서버 2세트 필요)                    | 낮음 (단일 서버, 포트만 다르게 운영)               |

---

### ✅ 요약

- **현재 방식은 블루그린의 전략(포트 분리 및 전환)을 차용했지만**, 인스턴스를 나누지 않고 **포트를 기준으로 구분**하며, 단일 서버 환경에서도 **거의 무중단 배포에 가까운 효과**
- 하지만 실제 블루그린처럼 완전히 분리된 환경은 아니므로, 롤백 속도나 안정성 측면에서 **블루그린보단 유연성이 떨어지고**, 구조적으로는 **롤링 배포에 더 가까운 방식**
## 🔚 마무리

이 구조는 완전한 블루그린 배포는 아니지만, **서비스의 중단을 최소화하면서도 단일 서버 환경에서 유연한 배포를 가능하게 한다**.
하지만 서버에 투자할 돈이 있다면 다중 인스턴스를 사용하자!
