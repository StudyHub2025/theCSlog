# CH2. 데이터베이스 생성과 관리

## 1. 키(Key)의 개념

### 기본 키 (Primary Key)
- 각 행(row)을 유일하게 식별할 수 있는 열(column).
- **중복 불가**, **NULL 불가**.
- 복합 키(여러 열 조합으로 구성) 가능.

```sql
CREATE TABLE student (
  student_id INT PRIMARY KEY,
  name VARCHAR(50),
  age INT
);
```

### 외래 키 (Foreign Key)
- 다른 테이블의 기본 키를 참조하는 열.
- 두 테이블 간 관계를 정의할 때 사용.

```sql
CREATE TABLE enrollment (
  enrollment_id INT PRIMARY KEY,
  student_id INT,
  FOREIGN KEY (student_id) REFERENCES student(student_id)
);
```

### 고유 키 (Unique Key)
- 중복되지 않는 값을 가짐. 단, NULL 허용.
- 여러 개 지정 가능.

```sql
CREATE TABLE user (
  user_id INT PRIMARY KEY,
  email VARCHAR(255) UNIQUE
);
```

---

## 2. 데이터베이스와 테이블 생성

### 데이터베이스 생성 및 사용

```sql
-- 데이터베이스 생성
CREATE SCHEMA my_database;

-- 데이터베이스 사용
USE my_database;
```

### 테이블 생성 예시

```sql
CREATE TABLE users (
  user_id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL,
  email VARCHAR(100) UNIQUE,
  birthdate DATE,
  registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 데이터 타입
- 숫자형: INT, FLOAT, DOUBLE, DECIMAL
- 문자형: CHAR, VARCHAR, TEXT
- 날짜형: DATE, TIME, TIMESTAMP
- 기타: ENUM, JSON 등

---

## 3. 데이터 입력 (INSERT)

```sql
-- 전체 컬럼 명시
INSERT INTO users (username, email, birthdate) 
VALUES ('kimuser', 'kim@example.com', '1999-08-01');

-- 특정 컬럼만 삽입
INSERT INTO users (username) 
VALUES ('honguser');
```

- **NOT NULL 제약 조건** 위반 시 오류 발생.
- 외래 키 제약 조건이 있다면 참조 테이블에 먼저 데이터가 있어야 함.

---

## 4. 데이터 조회 (SELECT)

### 기본 조회

```sql
SELECT * FROM users;
SELECT username, email FROM users;
```

### 조건 조회 (WHERE)

```sql
SELECT * FROM users WHERE user_id = 1;
```

### LIKE 패턴 검색

```sql
-- ‘kim’으로 시작하는
SELECT * FROM users WHERE username LIKE 'kim%';

-- ‘user’로 끝나는
SELECT * FROM users WHERE username LIKE '%user';
```

### 집계 함수 + GROUP BY + HAVING

```sql
SELECT user_id, SUM(price * amount) AS total_spent
FROM orders
GROUP BY user_id
HAVING total_spent > 500;
```

### 서브쿼리

```sql
SELECT * FROM users
WHERE user_id IN (SELECT user_id FROM orders WHERE amount > 5);
```

---

## 5. 데이터 수정 (UPDATE)

```sql
UPDATE users
SET email = 'newemail@example.com'
WHERE user_id = 1;
```

- `WHERE` 절 없으면 모든 행 수정됨.
- 외래 키 옵션 `ON UPDATE CASCADE`, `SET NULL` 등을 통해 참조 무결성 유지 가능.

---

## 6. 데이터 삭제 (DELETE)

```sql
-- 특정 조건에 해당하는 데이터 삭제
DELETE FROM users WHERE user_id = 1;

-- 모든 데이터 삭제 (구조는 유지)
DELETE FROM users;
```

- 외래 키 옵션 `ON DELETE CASCADE`, `SET NULL`, `RESTRICT` 설정 가능.

---

## 외래 키 제약 조건 요약

| 상황 | 옵션 | 설명 |
|------|------|------|
| 참조된 값 삭제 | `CASCADE` | 함께 삭제됨 |
| | `SET NULL` | 참조 컬럼을 NULL로 |
| | `SET DEFAULT` | 기본값으로 변경 |
| | `RESTRICT` / `NO ACTION` | 삭제 불가 |
