[Part 3. 네트워크]

* Ch 3 네트워크 계층
  - 네트워크 계층
    - 네트워크 간 통신이 가능한 계층
      - 기존엔 LAN에 국한된 통신(물리 계층과 데이터링크 계층)
      - 네트워크 간 통신이 되려면 **라우팅** 필요
    - 단편화가 이루어지는 계층
    - 네트워크 계층의 대표적인 프로토콜은 IP
  
  - MAC주소와 IP주소
    - 현재 MAC주소와 IP주소 둘 다 사용하지만 IP주소가 우선적으로 사용된다
      - MAC주소는 발신인/수신인
      - IP주소는 발신주소/수신주소
    - 주소 할당/변경
      - MAC
        - NIC 제작 시 MAC주소를 미리 할당
        - 주소 변경이 거의 없음
      - IP
        - **직접 할당** 가능
        - **DHCP 프로토콜**을 이용해 **자동 할당** 가능
        - 주소를 쉽게 변경할 수 있음
        
  - IP주소
    - 주요 기능
      1. IP 주소 지정
      2. 단편화
    - IP 프로토콜은 여러 버전이 존재하지만 **v4, v6**을 많이 사용
    - IPv4 헤더 주요 구성
      - 송신지, 목적지 IP주소
      - 식별자, 플래그, 단편화 오프셋
        - 단편화에서 주로 사용하는 헤더 정보
          - 식별자 : 패킷에 할당된 번호 (재조합 시 사용)
          - 플래그 : 부가 정보(미사용, Don’t Fragment, More Fragment 비트)
          - 단편화 오프셋 : 단편화되기 전 데이터가 얼마나 떨어져 있는가
      - TTL, 프로토콜
        - TTL(Time To Live) : 패킷의 수명, 라우터를 거칠 때마다 1 감소
        - 프로토콜 : 상위 계층의 프로토콜( e.g. TCP==6, UDP==17)
    - IPv4 주소
      - 4byte(32bit)로 표현 가능
      - 한 옥텟은 0 ~255 범위의 네 개의 십진수로 표기
        - . 을 기준으로 4개의 숫자로 표현하는데 각각의 숫자를 옥텟이라고 부름
      - 이론적으로 할당 가능한 IPv4 주소 개수 == 2^32개 **← 부족한 양**
        - **IP 주소 부족 문제 발생 → IPv6가 생긴 이유**
        - 생각보다 고갈 문제 해결 방법이 많이 생겨서 계속 사용중 (NAT)
    - IPv6 주소
      - 16byte(128bit)로 표현 가능
      - 이론적으로 할당 가능한 IPv6 주소 개수  == 2^128개 **← 사실상 무한**

-----
 - ARP   
   - IP주소는 알지만 MAC주소를 모르는 경우, MAC주소를 알아내기 위한 방법
     즉, **IP주소를 이용해 MAC주소를 알아내기 위해 사용하는 프로토콜**
   
 - ARP 동작 과정
   1. ARP 요청 → ARP 요청 패킷 전송
      - 기본적으로 브로드캐스트 메세지로 전송
   2. ARP 응답 → ARP 응답 패킷 전송
      - ARP 요청 메세지에 대한 응답(본인의 MAC주소 포함)
   3. ARP 테이블(ARP 캐시) 갱신
      - ARP 테이블(ARP 캐시) : MAC 주소와 IP 주소가 매핑된 표 형태의 데이터
      - 일정 시간이 지나면 삭제
      - ARP 테이블에 추가된 호스트는 브로드캐스트로 ARP 요청을 보낼 필요가 없다
 
----
 - **IP 프로토콜의 한계**
   - **비신뢰성** 전달 : 패킷이 목적지까지 제대로 전송한다는 보장이 없는 특성
     - 최선형 전달(best-effort delivery)라고도 불림
   - **비연결성** 전달 : 호스트 간의 사전 연결 수립(ex  회선교환 네트워크)이 없는 특성
   → 이 한계를 개선하기 위한 **전송 계층**
     전송 계층에서 대표적으로 **TCP** 프로토콜이 존재 - **신뢰성, 연결형 프로토콜을 제공**

 - ICMP
   - **IP 비신뢰성과 비연결형 특성을 보완**하기 위한 **네트워크 계층 프로토콜**
   - IP 패킷의 전송 과정에 대한 **피드백 메세지** 제공
     - 오류 보고
     - 네트워크 진단 정보
   - ICMP 메세지는 타입과 코드로 정의
   - ICMP는 IP의 한계를 보완할 뿐 완전히 해결하는 것은 아니다
     근본적인 해결은 전송 계층에서 이루어 진다
 
----
 - IP 주소의 구성 : 네트워크 주소, 호스트 주소
 - MAC 주소의 구성: 제조사 번호, 일련번호(비트 수 24/24비트 고정)

 - 주소 체계 종류
   - 클래스풀 주소 체계(옛날 방식)
     - class 개념을 바탕으로 네트워크 주소와 호스트 주소를 구분해서 관리
     - A,B,C,D,E  다양한 클래스가 존재
     - 클래스별로 정해져 있는 크기에 따라 호스트를 할당
       -> IP주소 낭비가 발생
   - 클래스리스 주소 체계
     - 클래스풀 주소 체계보다 더 정교히 네트워크를 나누는 방법
     - 오늘날 주로 사용하는 방식
     - 네트워크와 호스트를 구분하기 위해 **서브넷 마스크**를 이용

----
 - IP 주소의 분류
   - 공인 IP 주소 : 인터넷을 사용할 때 사용하는 고유한 주소 
   - 사설 IP 주소 : 사설 네트워크 내에서 사용하는 고유하지 않은 주소
     - LAN 내에서는 사설 IP는 중복될 수 있다
   
 - NAT : 공인 IP 주소와 사설 IP 주소 간의 변환 기능
   - **하나의 공인 IP 주소를 여러 사설 IP 주소가 공유 가능**
   - IP 주소 부족 문제 해결
 
 - 정적 IP주소와 동적 IP주소
   - IP 주소의 할당 방법 : **정적 할당**과 **동적 할당**
   - 정적 IP 주소: 정적 할당된 IP주소 (고정)
       - 직접 IP 부여
   - 동적 IP 주소: 동적 할당된 IP주소 (유동적)
     - **DHCP** 프로토콜
       - **동적 IP 주소를 할당하기 위한 프로토콜**
       - DHCP 서버에 의해서 동적으로 IP 주소를 할당 받음(==IP 주소를 임대)
       - 정해진 임대 시간이 끝날 경우 임대 갱신(자동 수행, 수동 수행)
       - 요청/응답 흐름
         1. DHCP Discover :  임대 요청 브로드 캐스트 메세지 전송
            - DHCP 서버는 여러 개 있을 수 있기 때문에 브로드캐스트로 보냄
         2. DHCP Offer : 앰대 가능 여부에 대한 DHCP서버들의 응답
         3. DHCP Request : 서버 응답을 보고 실제로 IP 주소를 요청
         4. DHCP Acknowledgement : DHCP에서 IP 주소 할당

----
 - 라우터
   - 네트워크 계층 장비
   - **라우팅** : 패킷이 이동할 최적의 경로를 설정, 해당 경로로 패킷 이동
   - **라우팅 프로토콜** : 라우팅을 수행하는 방법
     - 종류가 매우 다양함
     - 분류 방법
       - AS 내부 라우팅 프로토콜 (IGP) : RIP, OSPF
       - AS 외부 라우팅 프로토콜 (EFP) : BGP
       → AS란? 동일한 라우팅 정책으로 운영되는 라우터들의 집단 네트워크
   - **홉** : 라우터와 라우터 간의 패킷이 이동되는 하나의 과정을 하나의 홉이라고 한다
     - 홉 바이 홉 라우팅 : 홉이 거듭되면서 최종적인 목적지까지 패킷이 도달하는 라우팅 과정

   - 라우팅 테이블(routing table)
     - 특정 목적지까지 도달하기 위한 정보를 명시하는 표와 같은 정보
     - 대표적인 정보 : 목적지 주소, 서브넷 마스크, 게이트웨이, 인터페이스, 메트릭
     - 롱기스트 프리픽스 매치
       - 여러 라우팅 테이블 항목과 일치할 경우 **가장 길게 일치하는 항목 선택 후 패킷 전송**
     - 디폴트 라우트(default route)
       - 합치 되는 경로가 없을 경우 기본으로 내보낼 경로(0.0.0.0./0   == 모든 주소)
     - 라우팅 테이블이 만들어지는 방법
       - 정적 라우팅 : 수동으로 라우팅 테이블 항목 채워 넣기
       - 동적 라우팅 : 자동으로 라우팅 테이블에 항목 채워 넣기(라우팅 프로토콜 이용)
         - 장점 : 경로 우회 가능


* Ch 3 전송 계층
  - 전송 계층의 역할
    - 응용 계층의 어플리케이션 프로세스 식별 : 포트(Port)를 사용
    - 네트워크 계층의 신뢰성/연결성 확립

  - 포트(Port)
    - 어플리케이션 프로세스를 식별해주는 고유한 번호
    - 포트 범위별 종류
      - 잘 알려진 포트 == 웰 노운 포트 == 시스템 포트
        - ex) 22, 80, 443
      - 등록된 포트
        - 특정 기업, 특정 어플리케이션을 위해 할당 되는 경우가 많다
        - ex) 3306, 8080
      - 동적포트 == 사설포트 == 임시 포트
        - 사용자가 자유롭게 할당 가능한 포트
        - 서버는 일반적으로 잘 알려진 포트와 등록된 포트로 동작하는데
          클라이언트는 일반적으로 동적 포트로 동작한다
        - 동적 포트는 랜덤으로 할당 받는다

  - Port를 활용한 NAT
    - NAT 변화 테이블
      - NAT 기능을 제공하고 있는 라우터 또는 공유기 내에는 NAT 변화 테이블이 존재
      - 같은 공인 IP를 공유해도 port 번호만 다르게 적용하면 같은 공인 IP를 다르게 사용 가능
        - ex)
          192.168.0.5 사설 IP가 1.2.3.4 공인 IP로 변환 될 때 6200 포트로 변환되어 나감
          192.168.0.6 사설 IP가 1.2.3.4 공인 IP로 변환 될 때 6201 포트로 변환되어 나감

----
 - 참고
   - TCP는 세그먼트 , UDP는 데이터그램 이라고 부름
   - MSS : TCP 세그먼트로 보낼 수 있는 최대 크기
 - TCP와 UDP
   - TCP 세그먼트 구조 
     - 중요 부분
       - 출발지 포트 / 목적지 포트
       - **순서 번호(시퀀스 넘버) :**  송수신 되는 세그먼트 데이터 첫 바이트에 부여되는 번호
       - **확인 응답 번호 :** 순서 번호에 대한 응답(다음으로 수신 받길 기대하는 바이트 번호)
       - 제어비트
         - **ACK** : 세그먼트 승인을 나타내는 비트
         - **SYN** : 연결 수립을 위한 비트
         - **FIN** : 연결을 끝내기 위한 비트
           → TCP는 연결지향형 프로토콜이기 때문에 SYN,FIN 필요
         - RST : 연결을 리셋하기 위한 비트
       - 윈도우 : 수신지 윈도우 크기 / 한번에 수신 받고자 하는 양
   - UDP 데이터그램 구조
     - TCP에 비해 제공하는 기능이 적어 구조가 단순
     - 비연결성/비신뢰성 프로토콜
     - 신뢰성은 떨어지지만 빠른 성능은 보장하기 때문에 최근 가광 받고 있음